#!/usr/bin/perl
=pod

SBX chooser

=head1 NAME

  sbx - Tool voor menu-selectie sandboxes.

=head1 DESCRIPTION

Keuze sandbox en het starten van de shell omgeving.

=head1 .sbxconfig

Configuratie file for your shell environment.

vb
   [foo]
      SBX=$HOME/sbx

=over 12

=item C<[item]>

Menu item shortname

=item C<SBX>

    Root of your sandbox
    The 'sb' alias return you to your sandbox.


=back

=head1 LICENSE

=head1 AUTHOR

Hans Mulder - H_Mulder@belastingdienst.nl

=head1 SEE ALSO

=cut

#
# GLOBALS in GLB

my %GLB={
            hostname => 'localhost'
        };
$GLB{hostname}=`hostname`;
$GLB{uname}=`uname`;
chomp $GLB{uname};
chomp $GLB{hostname};

#
#CONFIG
#
package CONFIG;
use Data::Dumper;

my %CFG=();
sub  trim { my $s = shift; $s =~ s/^\s+|\s+$//g; return $s };
sub import()
{
  my $config_file="$ENV{HOME}/.sbxconfig";
  my $label="global";#default environment
  open CONFIG, $config_file or die "Could not open '$config_file':$!";
  while( <CONFIG> ){
    chomp;
    next if /^#/;#skip comment starting with #
    #$label = s/(^\[)||(\]$)// if /^\[/ ;
    s/[^\\]#.*//;  #strip comment
    if( m/^\[/ ){
      s/(^\[)||(\]$)//g;
      $label=$_;
    };
    if( m/=/ ){
      my ($var,$val)=split(/=/);
      $CFG{$label}{trim $var}= trim $val;
    }
  }
  #
	print "user_config".Dumper(\%CFG)."\n";
    
  close CONFIG;
}
sub get_group($)
{
  my $group=shift;
  return $CFG{$group};
}

#
#MENU
#
package MENU;
sub get_items()
{
  #TODO filter op menu
  my @items=();
  foreach my $grp ( keys %CFG ){
    push @items, $grp if $CFG{$grp}{menu} eq 'true';
  }
  return @items;
}
sub menu()
{
  my @options=get_items();

 	#!TODO enter toets geeft keuze en gaat dus door.
	my $nr=1;
	#print "user_menu".Dumper(\%menu)."\n";
	foreach(@options){
		print $nr++.") $_\n";
	}

	my $choice;
	while(1){
        	print "Select one [1..".($nr-1).']?';
        	$choice=<STDIN>;
		chomp $choice;
		$choice=1 if $choice eq '';#default
		last if $choice > 0 and $choice < $nr ;
	};

	return $options[$choice-1];
}

#
#Environment
#
package ENV;
use Data::Dumper;
sub create($)
{
  my $group=shift;
  #TODO create environment
  my $env=CONFIG::get_group($group);
	print "DBG:env".Dumper($env)."\n";
  foreach( keys $env ) {
    $ENV{$_}=$env->{$_};
  }
}

sub sub_vars($)
{
  my $group=shift;
  my $env=CONFIG::get_group($group);

  my $found=0;
  do{
    $found=0;
    foreach my $var ( keys $env ) {
      #$ENV{$_}=$env->{$_};
      #print "DBG:test $var\n";
      if( $env->{$var} =~ m/\$\{([^}]*)\}/ ){
          my $varvar=$1;
          $env->{$var} =~ s/\$\{[^}]*\}/$ENV{$varvar}/ if  $ENV{$varvar};
          print "DBG:found $varvar, $ENV{$varvar} in \${} in $env->{$var}\n";
          $found=1;
        }
    }
  }while($found);
}
sub start()
{
  #TODO start shell
  print "DBG:chdir( $ENV{SBXROOT} )\n";
  chdir( $ENV{SBXROOT} );
  system('sh');
}
#
# MAIN
# 
package MAIN;

print "Start\n";
CONFIG::import();
my $choice=MENU::menu();
print "choice=$choice\n";
ENV::create($choice);
ENV::sub_vars($choice);
ENV::create($choice);
ENV::start();
